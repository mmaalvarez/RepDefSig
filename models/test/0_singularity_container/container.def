BootStrap: yum
OSVersion: 7
MirrorURL: http://mirror.centos.org/centos-%{OSVERSION}/%{OSVERSION}/os/$basearch/
Include: yum
Stage: build


%environment

    export LC_ALL=C


%post

    ## install basics for CentOS 7

    yum -y update ; yum -y install wget java-11-openjdk-devel which dnf libcurl-devel openssl-devel libxml2-devel


    ## install nextflow

    wget -qO- https://get.nextflow.io | bash ; cp nextflow /usr/local/bin/


    ## install R 4.1.3

    # Enable the Extra Packages for Enterprise Linux (EPEL) repository
    yum -y install https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm 

    # Enable the Optional repository from Red Hat Update Infrastructure (RHUI)
    yum -y install yum-utils 
    yum-config-manager --enable "rhel-*-optional-rpms"

    # Download and install R
    export R_VERSION=4.1.3
    curl -O https://cdn.rstudio.com/r/centos-7/pkgs/R-${R_VERSION}-1-1.x86_64.rpm
    yum -y install R-${R_VERSION}-1-1.x86_64.rpm

    # Create symlink to R
    ln -s /opt/R/${R_VERSION}/bin/R /usr/local/bin/R
    ln -s /opt/R/${R_VERSION}/bin/Rscript /usr/local/bin/Rscript


    ## install R packages

    R --slave -e 'install.packages("curl", repos="https://cran.rstudio.com/")'
    R --slave -e 'install.packages("openssl", repos="https://cran.rstudio.com/")'
    R --slave -e 'install.packages("httr", repos="https://cran.rstudio.com/")'
    R --slave -e 'install.packages("gargle", repos="https://cran.rstudio.com/")'
    R --slave -e 'install.packages("googledrive", repos="https://cran.rstudio.com/")'
    R --slave -e 'install.packages("googlesheets4", repos="https://cran.rstudio.com/")'
    R --slave -e 'install.packages("xml2", repos="https://cran.rstudio.com/")'
    R --slave -e 'install.packages("rvest", repos="https://cran.rstudio.com/")'
    R --slave -e 'install.packages("tidyverse", repos="https://cran.rstudio.com/")'
    R --slave -e 'install.packages("conflicted", repos="https://cran.rstudio.com/")'
    R --slave -e 'install.packages("BiocManager", repos="https://cran.rstudio.com/")'
    R --slave -e 'BiocManager::install("XVector")'
    R --slave -e 'BiocManager::install("GenomicRanges")'
    R --slave -e 'BiocManager::install("rtracklayer")'
    R --slave -e 'install.packages("broom.mixed", repos="https://cran.rstudio.com/")'
    R --slave -e 'install.packages("data.table", repos="https://cran.rstudio.com/")'
    R --slave -e 'install.packages("sampling", repos="https://cran.rstudio.com/")'
    R --slave -e 'install.packages("NMF", repos="https://cran.rstudio.com/")'
    R --slave -e 'install.packages("lsa", repos="https://cran.rstudio.com/")'
    R --slave -e 'install.packages("cluster", repos="https://cran.rstudio.com/")'
    R --slave -e 'install.packages("ggrepel", repos="https://cran.rstudio.com/")'
    R --slave -e 'install.packages("cowplot", repos="https://cran.rstudio.com/")'
    R --slave -e 'install.packages("RcppEigen", repos="https://cran.rstudio.com/")'
    R --slave -e 'install.packages("RcppML", repos="https://cran.rstudio.com/")'
    # install older valr version 0.6.3 from source, as newer versions were raising errors during the installation
    wget https://cran.r-project.org/src/contrib/Archive/valr/valr_0.6.3.tar.gz
    R --slave -e 'install.packages("valr_0.6.3.tar.gz", repos=NULL, type="source")'


%test

    grep -q NAME=\"CentOS\ Linux\" /etc/os-release
    if [ $? -eq 0 ]; then
        echo "Container base is CentOS as expected"
    else
        echo "WARNING: container base is not CentOS!"
    fi

    grep -q VERSION=\"7\ \(Core\)\" /etc/os-release
    if [ $? -eq 0 ]; then
        echo "CentOS version is 7 (Core) as expected"
    else
        echo "WARNING: container base (should be CentOS) version is not 7 Core!"
    fi


%labels

    Author miguelmartin.alvarez@irbbarcelona.org
    Version v0.0.1


%help

    Nextflow pipeline that 

    
    Input formats
    -------------

    input1: 


    Pipeline
    --------

    1- 


    Example output
    --------------


